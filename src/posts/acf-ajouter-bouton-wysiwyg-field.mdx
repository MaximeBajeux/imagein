---
title: "ACF Wysiwyg: Comment ajouter un bouton √† la toolbar de TinyMCE ?"
label: "ACF Wysiwyg: Comment ajouter un bouton √† la toolbar de TinyMCE ?"
h1: "ACF Wysiwyg: Comment ajouter un bouton √† la toolbar de TinyMCE ?"
slug: "acf-wysiwyg-ajouter-custom-button-toolbar-tinymce"
date: "2023-10-29"
description: "La documentation officielle d'ACF ne documente pas comment ajouter un bouton personnalis√© √† la toolbar de TinyMCE, pourtant il existe un hook permettant de le faire. C'est ce que nous allons voir ici"
imageURL: "https://smnarnold.com/assets/page-previews/acf.jpg"
imageAlt: "Le logo d'ACF"
type: "article"
categories: ["Programmation"]
---

Dans l'univers Wordpress actuel, ACF (Advanced Custom Field) a pris une place importante dans l'√©cosyst√®me tant sa flexibilit√© le rend performant dans son utilisation. C'est pourquoi il a √©t√© le choix judicieux de l'ancien prestataire d'un de mes clients dans le d√©veloppement de leur site internet. Wordpress est ici utilis√© en mode headless avec un frontend NextJS, figure p√©rilleuse mais tr√®s performante au rendu finale ! N√©anmoins mon client avait une requ√™te, pouvoir ajouter un CTA (Call To Action) dans une zone de texte enrichie. Facile ! Ou pas‚Ä¶

**Disclaimer:** A moins d'√™tre d√©veloppeur vous-m√™me, il y a peu de chance que vous trouviez le quelconque int√©r√™t √† cet article.

![Le logo d'advanced custom field](https://smnarnold.com/assets/page-previews/acf.jpg)

## En quoi consiste la demande exactement ?

En soit, la demande aurait pu √™tre trait√©e tr√®s rapidement, on explique √† l'√©quipe comment modifier en mode texte les balises \<a\> pour leur ajouter un "class="cta" et il aurait alors suffit de g√©rer l'affichage c√¥t√© NextJS.

Mais vous le savez, les clients n'aiment pas les solutions "√† base de code". Il faut des boutons √† cliquer et c'est compr√©hensible. Du coup, comment faisons nous ? ACF utilise TinyMCE dans son Wysiwyg Field. L'un comme l'autre sont assez bien document√©s, il est facile de trouver comment modifier la toolbar dans la doc d'ACF, et comment cr√©er un nouveau bouton du c√¥t√© de TinyMCE. On met tout √ßa dans un plugin maison et voil√† ce que √ßa donne.

```js
<?php
/*
Plugin Name: ACF Custom Button
Description: Adds a custom button to the ACF TinyMCE toolbar
Version: 1.0
Author: Maxime Bajeux
*/

// Register the custom button script
function acf_custom_button_plugin() {
    wp_enqueue_script('acf_custom_button_script', plugin_dir_url(__FILE__) . 'button.js');
}
add_action('acf/input/admin_enqueue_scripts', 'acf_custom_button_plugin');

// Add the custom button to the ACF TinyMCE toolbar
function my_acf_toolbars($toolbars) {
	$toolbars['Full'] = array();
    $toolbars['Full'][1] = array('bold', 'italic', 'custom_button');
    return $toolbars;
}
add_filter('acf/fields/wysiwyg/toolbars', 'my_acf_toolbars');

?>
```

```js
jQuery( document ).on( 'tinymce-editor-init', function( event, editor ) {
  tinymce.PluginManager.add('custom_button', function(editor, url) {
    editor.addButton('custom_button', {
      text: 'CTA',
      icon: false,
      onclick: function() {
        var selected_text = editor.selection.getContent();
        var href = prompt("Enter the href value:");
        var html = '<a class="cta" href="' + href + '">' + selected_text + '</a>';
          editor.execCommand('mceInsertContent', false, html);
        }
      });
  });
});
```

Sauf que ce code ne fonctionne absolument pas ü§° PluginManager n'existe simplement pas dans l'instance tinymce que l'on re√ßoit √† cet endroit. En remarquant cela et que la fonction addButton existait j'ai donc essay√© de simplement faire comme ci-dessous, √ßa n'a pas march√© non plus bien que je voyais mon bouton s'afficher dans la liste.

```js
jQuery( document ).on( 'tinymce-editor-init', function( event, editor ) {
  editor.addButton('custom_button', {
    text: 'CTA',
    icon: false,
    onclick: function() {
      var selected_text = editor.selection.getContent();
      var href = prompt("Enter the href value:");
      var html = '<a class="cta" href="' + href + '">' + selected_text + '</a>';
      editor.execCommand('mceInsertContent', false, html);
    }
  });
});
```

## La bo√Æte noire des plugins Wordpress

A chaque fois que je travaille sur des probl√©matiques un peu corner case dans l'√©cosyst√®me Wordpress il se passe la m√™me chose, la documentation est inexistante. J'ai dit plus t√¥t que TinyMCE et ACF √©taient bien document√©s, c'est vrai, mais pour l'√©cosyst√®me Wordpress. Il existe toujours des zones extr√™mement opaques o√π "la magie op√®re" et √† moins de mettre les mains dans le code, il n'y a pas vraiment moyen de savoir comment sortir du sentier trac√© par le plugin.

En l'occurrence, si ACF pr√©voit de nous permettre de modifier la barre d'outil avec les boutons d√©j√† existants du plugin ([https://www.advancedcustomfields.com/resources/customize-the-wysiwyg-toolbars/](https://www.advancedcustomfields.com/resources/customize-the-wysiwyg-toolbars/)), elle ne documente pas le moyen d'y ajouter un bouton cr√©√© par nos soins. Pourtant, Il a √©t√© pr√©vu que nous puissions le faire, puisqu'ils ont pr√©vu le hook permettant de le faire !

## La solution !

C'est apr√®s plusieurs heures de recherche que j'ai fini par d√©couvrir le filter "wysiwyg_tinymce_settings" dans un forum d'ACF ([https://support.advancedcustomfields.com/forums/topic/acf-block-custom-tinymce-button-postmeta-database-duplication/](https://support.advancedcustomfields.com/forums/topic/acf-block-custom-tinymce-button-postmeta-database-duplication/)) qui m'a permis d'arriver au r√©sultat que je souhaitais.

Voici donc le plugin dans sa version fonctionnelle apr√®s des heures de larmes et de haine üòÖ

```js
<?php
/*
Plugin Name: ACF Custom Button
Description: Adds a custom button to the ACF TinyMCE toolbar
Version: 1.0
Author: Maxime Bajeux
*/

function my_acf_input_admin_footer() {
?>
<script type="text/javascript">

acf.add_filter('wysiwyg_tinymce_settings', function(mceInit, id, field) {
    mceInit.verify_html = false;
    mceInit.plugins = 'textcolor,colorpicker,lists,fullscreen,image,wordpress,wpeditimage,wplink,hr';
    mceInit.toolbar1 = 'formatselect,bold,italic,underline,strikethrough,forecolor,blockquote,hr';
    mceInit.toolbar2 = 'alignleft,aligncenter,alignright,alignjustify,bullist,numlist,link,unlink,undo,redo,removeformat,customButton';
    mceInit.setup = function(ed){
        ed.addButton( 'customButton', {
            type: 'button',
            text: 'CTA',
            onclick: function() {
                // Open a TinyMCE modal window
                ed.windowManager.open({
                    title: 'Insert CTA Link',
                    body: [
                        {type: 'textbox', name: 'url', label: 'URL'},
                        {type: 'checkbox', name: 'newTab', label: 'Open in a new tab', checked: true},
                    ],
                    onsubmit: function(e) {
                        var url = e.data.url;
                        var newTab = e.data.newTab ? ' target="_blank"' : '';
                        var selected_text = ed.selection.getContent();
                        var html = '<a class="cta" href="' + url + '"' + newTab + '>' + selected_text + '</a>';
                        ed.execCommand('mceInsertContent', false, html);
                    }
                });
            }
        });
    }
    return mceInit;
});

</script>
<?php
}

add_action('acf/input/admin_footer', 'my_acf_input_admin_footer');
?>
```

Je l'ai √©galement ajout√© √† mon Github en public: [https://github.com/MaximeBajeux/acf-custom-wysiwyg/tree/main](https://github.com/MaximeBajeux/acf-custom-wysiwyg/tree/main)

Ce n'est, comme le Readme le dit si bien, qu'un "Shitty POC". J'ai fait en sorte que √ßa fonctionne dans mon cas d'usage, pas que ce soit un plugin utilisable en plug and play par la communaut√©, mais puisque c'est un cas d'usage tr√®s peu document√©, il me semblait n√©cessaire de le mettre √† disposition pour offrir une base de travail √† ceux qui auraient le m√™me besoin.

Peut-√™tre en ferais-je une version plus aboutit √† l'avenir ou mieux document√©e sur la mani√®re dont √ßa fonctionne c√¥t√© ACF. En attendant je vous laisse avec ce petit plugin permettant d'ajouter un bouton √† la toolbar du Wysiwyg Field d'ACF.
